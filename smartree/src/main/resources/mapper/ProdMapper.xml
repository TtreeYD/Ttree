<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.yedam.smartree.prod.mapper.ProdMapper">
  	<select id="selectProdList" resultType="ProdVO">
  		select *
		from dt_prod_plan dtp join prod_plan p 
		on dtp.prod_plan_code = p.prod_plan_code
		join  prdt_table pt 
		on dtp.prdt_code = pt.prdt_code
  	</select>
  	
  	<select id="selectAllOrderAndPrdt" resultType="BusinessVO">
  		select o.order_code , b.bp_code , b.bp_name , o.order_date , o.dod_date , o.dod_state , o.order_manager
  		from orders o join business_partner b
 		  				on o.bp_code = b.bp_code
		  				where o.prod_plan_yn = 'n'
  	</select>
  	
  	
	<insert id="insertProdPlan" parameterType="ProdVO" statementType="CALLABLE">
    <selectKey keyProperty="prodPlanCode" resultType="String" order="BEFORE">
        select 'PPN' || LPAD(prod_plan_seq.NEXTVAL, 7, '0') as prodPlanCode from dual
    </selectKey>
    {call in_prod_up_order(
        #{orderCode},
        #{prodPlanCode},
        #{prodPlanName},
        #{prodPlanDate},
        #{prodName},
        #{prodPlanSdate},
        #{prodPlanEdate}
    )}
	</insert>
	
	<insert id="insertDtProdPlan" parameterType="ProdVO">
	    insert into dt_prod_plan
	    values(
	        'PPD' || LPAD(dt_prod_plan_seq.NEXTVAL, 7, '0'),
	        #{prodPlanCode},
	        #{prdtCode},
	        #{prodPlanCnt},
	        #{prodPlanNote},
	        #{prodRank}
	    )
	</insert>
	 <insert id="insertAndUpdateDtProd" parameterType="ProdVO">
		{call in_dtProd_up_dtProd(
			#{prodPlanCode},
			#{prdtCode},
			#{prodPlanCnt},
			#{prodPlanNote},
			#{prodRank},
			#{dtProdPlanCode},
			#{prodPlanName},
  		    #{prodName},
  		    #{prodPlanDate},
  		    #{prodPlanSdate},
  		    #{prodPlanEdate}
		)}
	</insert> 
  	<select id="searchProdPlan" resultType="ProdVO">
  		select *
		from dt_prod_plan dtp join prod_plan p 
		on dtp.prod_plan_code = p.prod_plan_code
		join  prdt_table pt
		on dtp.prdt_code = pt.prdt_code
		<where>
			<if test="dtProdPlanCode != null and !dtProdPlanCode.equals('')">
				dtp.dt_prod_plan_code like '%' || #{dtProdPlanCode} || '%'
			</if> 
			<if test="prdtName != null and !prdtName.equals('')">
				or pt.prdt_name like '%' || #{prdtName} || '%'
			</if>
		</where>
  	</select>
  	
  	<select id="selectProd" resultType="ProdVO">
  		select prod_plan_code, prod_plan_name, prod_name, prod_plan_date, order_code
  		from prod_plan
  	</select>
  	
  	<select id="selectProdListView" resultType="ProdVO">
  		SELECT dtp.dt_prod_plan_code, dtp.prod_plan_cnt, dtp.prod_rank, dtp.prod_plan_note
  		     , p.prod_plan_code , p.prod_plan_name, p.prod_name, p.prod_plan_date, p.prod_plan_sdate, p.prod_plan_edate
  		     , pt.prdt_name , pt.prdt_code
		<if test="orderCode != null and !orderCode.equals('')">
	  		, nvl(dto.order_dt_cnt, 0) order_dt_cnt
        </if>
		FROM dt_prod_plan dtp JOIN prod_plan p 
		ON dtp.prod_plan_code = p.prod_plan_code
		JOIN  prdt_table pt 
		ON dtp.prdt_code = pt.prdt_code
		<if test="orderCode != null and !orderCode.equals('')">
	        LEFT OUTER JOIN dt_order dto
	        ON p.order_code = dto.order_code AND dtp.prdt_code = dto.prdt_code
        </if>
		WHERE p.prod_plan_code = #{prodPlanCode}
  	</select>
  	
  	<update id="updateProd" parameterType="ProdVO">
  		update prod_plan
  		set prod_plan_name = #{prodPlanName},
  		    prod_name = #{prodName},
  		    prod_plan_date = #{prodPlanDate},
  		    prod_plan_sdate = #{prodPlanSdate},
  		    prod_plan_edate = #{prodPlanEdate}
  		where prod_plan_code = #{prodPlanCode}
  	</update>
  	
  	<update id="updateDtProd" parameterType="ProdVO">
  		update dt_prod_plan
  		set prod_plan_cnt = #{prodPlanCnt},
  		    prod_rank = #{prodRank},
  		    prod_plan_note = #{prodPlanNote}
  		where dt_prod_plan_code = #{dtProdPlanCode}
  	</update>
  	
  	<delete id="deleteProd" parameterType="ProdVO">
  		delete from prod_plan
  		where prod_plan_code = #{prodPlanCode}
  	</delete>
  	
  	<delete id="deleteDtProd" parameterType="ProdVO">
  		delete from dt_prod_plan
  		where dt_prod_plan_code = #{dtProdPlanCode}
  	</delete>
  	
  	<select id="selectPrdt" resultType="PrdtProdVO">
  		select p.prod_plan_code , pt.prdt_code , pt.prdt_name , pt.prdt_type 
  		from prdt_table pt join dt_prod_plan p
  		                     on pt.prdt_code = p.prdt_code
  		<where>
  			<if test="prdtCode != null">
  				pt.prdt_code = #{prdtCode}
  			</if>
  			<if test="prodPlanCode != null and !prodPlanCode.equals('')">
  				AND p.prod_plan_code = #{prodPlanCode}
  			</if>
  		</where>
  	</select>
  	
  	<select id="selectGetProd" resultType="ProdVO">
		select p.prod_plan_name, dtp.prod_plan_cnt
		from prod_plan p join dt_prod_plan dtp
		                 on p.prod_plan_code = dtp.prod_plan_code
		where p.prod_plan_code = #{prodPlanCode}
  	</select>
  </mapper>