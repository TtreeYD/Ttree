<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
  <mapper namespace="com.yedam.smartree.eqm.mapper.EqmMapper">
  <!-- 설비 전체조회 -->
  	<select id="selectEqmList" resultType="EqmVO">
  		select e.* , (
                select max(RECENT_INSP_DATE)
                from eqm_insp i
                WHERE e.eqm_code = i.eqm_code ) as RECENT_INSP_DATE,
                 (
                select max(NEXT_INSP_DATE)
                from eqm_insp i
                WHERE e.eqm_code = i.eqm_code ) as NEXT_INSP_DATE
        from eqm e
        ORDER BY eqm_code
  	</select>
  	<!-- 사용여부 조회 -->
  	<select id="selectEqmUcheckList" resultType="EqmVO">
  		SELECT e.eqm_code,e.eqm_name,e.eqm_ucheck,e.insp_cycle,e.mfg_comp,e.mfg_date,i.RECENT_INSP_DATE,i.NEXT_INSP_DATE
		FROM eqm e left join EQM_INSP i
  		  				ON e.eqm_code = i.eqm_code
  		<where>
  			<if test="eqmUcheck != null and !eqmUcheck.equals('')">
  				eqm_ucheck = #{eqmUcheck}	
  			</if>
  		</where>  				
  		 
  		ORDER BY eqm_code
  	</select>
  	

	<!-- 설비이름으로 검색 -->
  	  <select id="searchEqm" resultType="EqmVO">
  		select e.* , (
                select max(RECENT_INSP_DATE)
                from eqm_insp i
                WHERE e.eqm_code = i.eqm_code ) as RECENT_INSP_DATE,
                 (
                select max(NEXT_INSP_DATE)
                from eqm_insp i
                WHERE e.eqm_code = i.eqm_code ) as NEXT_INSP_DATE
        from eqm e
  		<where>
  			<if test="eqmName != null and !eqmName.equals('')">
  				e.eqm_name LIKE '%'||#{eqmName}||'%'
  			</if>
  		</where>  				
  		 
  		ORDER BY eqm_code
  	</select>
  	<!-- 설비조회 단건조회-->
  	<select id="selectEqm" resultType="EqmVO">
  	select eqm_code,eqm_name,eqm_ucheck,insp_cycle,eqm_min_temp,eqm_max_temp,eqm_manager,mfg_comp,mfg_date,eqm_img,eqm_division
  	from EQM
  	where eqm_code=#{eqmCode} 
  	</select>
  	
  	
  	<!-- 설비등록  -->
  	<insert id="insertEqm" parameterType="EqmVO">
  	<selectKey keyProperty="eqmCode" resultType="String" order="BEFORE">
  		select 'eqm' || LPAD(eqm_code_seq.NEXTVAL, 7, '0') as eqmCode from dual
  	</selectKey>
  	INSERT INTO EQM
  			 ( 
  			    EQM_CODE
  			   ,EQM_NAME
  			   ,EQM_UCHECK
  		  	   ,EQM_MIN_TEMP
  			   ,EQM_MAX_TEMP
  			   ,EQM_MANAGER
  			   ,INSP_CYCLE
  			   ,MFG_COMP
  			   ,MFG_DATE
  			   ,EQM_IMG
  			   ,EQM_DIVISION
  			)
   values
           ( 
   				#{eqmCode}
   			   ,#{eqmName}
   			   ,#{eqmUcheck}
   			   ,#{eqmMinTemp}
   			   ,#{eqmMaxTemp}
   			   ,#{eqmManager}
   			   ,#{inspCycle}
   			   ,#{mfgComp}
   			   ,#{mfgDate}   
   			   ,#{eqmImg}
   			   ,#{eqmDivision}
   			
           )
  	
  	
  	</insert>
  	
  	<!-- 설비삭제 -->
  	<delete id="deleteEqm" parameterType="EqmVO">
  		delete from EQM
  		where eqm_code= #{eqmCode}
  	</delete>
  	
  	<!-- 설비 수정 -->
  	<update id="updateEqm" parameterType="EqmVO">
  		update EQM
  		<set>
  			<if test="eqmName != null and !eqmName.equals('')">
  			     EQM_NAME=#{eqmName},
  			</if>
  			<if test="eqmUcheck != null and !eqmUcheck.equals('')">
  			       EQM_UCHECK =#{eqmUcheck},
  			</if>
  			<if test="eqmMinTemp != null and !eqmMinTemp.equals('')">
  			       EQM_MIN_TEMP =#{eqmMinTemp},
  			</if>
  			<if test="eqmMaxTemp != null and !eqmMaxTemp.equals('')">
  			       EQM_MAX_TEMP =#{eqmMaxTemp},
  			</if>
  			<if test="eqmManager != null and !eqmManager.equals('')">
  			       EQM_MANAGER =#{eqmManager},
  			</if>
  			<if test="inspCycle != null and !inspCycle.equals('')">
  			       INSP_CYCLE =#{inspCycle},
  			</if>
  			<if test="mfgComp != null and !mfgComp.equals('')">
  			       MFG_COMP =#{mfgComp},
  			</if>
  			<if test="mfgDate != null and !mfgDate.equals('')">
  			       MFG_DATE =#{mfgDate},
  			</if>
  			<if test="eqmImg != null and !eqmImg.equals('')">
  			       EQM_IMG =#{eqmImg},
  			</if>
  			<if test="eqmDivision != null and !eqmDivision.equals('')">
  			       EQM_DIVISION =#{eqmDivision}
  			</if>
  		
  		</set>
  		where eqm_code=#{eqmCode}
  	</update>
  	
  	<!-- 설비 구분으로 조회 -->
  	<select id="searchEqmDivision" resultType="EqmVO">
  	select eqm_code,eqm_name,eqm_ucheck,insp_cycle,eqm_min_temp,eqm_max_temp,eqm_manager,mfg_comp,mfg_date,eqm_img,eqm_division
  	from EQM
  	where eqm_division = #{eqmDivision} 
  	</select>
  	

  	
  </mapper>