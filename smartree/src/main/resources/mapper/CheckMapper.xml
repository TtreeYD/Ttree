<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
  <mapper namespace="com.yedam.smartree.check.mapper.CheckMapper">
  
  	<!-- 제품목록 -->
  	<select id="selectPrdtList" resultType="BpVO">
  		select prdt_code,
  			   prdt_name,
  			   prdt_type
  		from prdt_table
  		<where>
  			<if test="prdtCode != null">
  				prdt_code = #{prdtCode}
  			</if>
  		</where>
  	</select>
  	
  	<!-- 제품검사기준목록 -->
  	<select id="selectPrdtStdList" resultType="CheckVO">
  		select chk_std_code,
  		       chk_name,
  		       chk_dt,
  		       chk_std
  		from chk_std
  		<where>
  			<if test="chkStdCode != null">
  				chk_std_code = #{chkStdCode}
  			</if>
  		</where>
  	</select>
  
  	<insert id="insertPrdtChkStd" parameterType="CheckVO">
  		insert into prdt_chk_list(chk_std_code, prdt_chk_num, prdt_code, chk_std)
  		values (
  			#{chkStdCode},
  			#{prdtChkNum},
  			#{prdtCode},
  			#{chkStd}
  		) 

  	</insert>
  
  <!-- 완제품검사목록 -->
  <select id="selectProdCheckList" resultType="CheckVO">
  	select p.pass_cnt, 
  		   p.prcs_rs_code,
  		   p.prdt_code,
  		    
  		   d.prod_inst_code, 
  		   
  		   i.prod_inst_date
	from process_result p
	JOIN process r 
	  ON p.prcs_code = r.prcs_code
    JOIN dt_prod_inst d 
      ON r.dt_prod_inst_code = d.dt_prod_inst_code
    JOIN prod_inst i 
      ON d.prod_inst_code = i.prod_inst_code
      
	WHERE r.prod_yn = 'y'

  </select>
  
  <!-- 완제품검사상세목록 -->
  <select id="selectProdDtList" resultType="CheckVO">
SELECT 
         s.chk_name, 
         s.chk_std,
         
         c.chk_std_code,
         c.prdt_chk_num
  FROM prdt_chk_list c
  JOIN chk_std s
    ON c.chk_std_code = s.chk_std_code
  
   WHERE c.prdt_code = #{prdtCode}

  </select>  
  <!-- 완제품검사 저장 -->
  	<insert id="insertProdChk" parameterType="CheckVO">
  	<selectKey keyProperty="prdtChkCode" resultType="String" order="BEFORE">
  		select 'PDC' || LPAD(prdt_chk_seq.NEXTVAL, 5, '0') as prdtChkCode from dual
  	</selectKey>
  	insert into prdt_chk(
  						 prdt_chk_code,
  						 prdt_code,
  						 prcs_rs_code,
  						 prdt_chk_cnt

  						)
  	values (
  			#{prdtChkCode},
  			#{prdtCode},
  			#{prcsRsCode},
  			#{passCnt}

  	)					
  	</insert>
  <!-- 완제품검사상세 저장 -->
    <insert id="insertDtProdChk" parameterType="CheckVO">
  	insert into dt_prdt_chk(
  							prdt_chk_code,
  							prdt_code,
  							chk_std_code,
  							prdt_chk_val,
  							prdt_chk_fit,
  							prdt_manager
  						   )
  	values (
  		 #{prdtChkCode},
  		 #{prdtCode},
  		 #{chkStdCode},
  		 #{prdtChkVal},
  		 #{prdtChkFit},
  		 #{prdtManager}
  	) 
  </insert>  
  
  <!-- 완제품 결과수정 -->
  <update id="updatePrdtChk" parameterType="CheckVO">
  	update prdt_chk
  	set prdt_chk_result = '부적합'
  	where prdt_chk_code = #{prdtChkCode}
  </update>
  
  <!-- 완제품검사조회목록 -->
  <select id="selectPrdtCheckList" resultType="CheckVO">
  	select *
  	from prdt_chk c
  	JOIN prdt_table t 
  	  ON c.prdt_code = t.prdt_code
  	  
  </select>
  
  <!-- 완제품검사상세조회목록 -->
  <select id="selectdtList" resultType="CheckVO">
  SELECT p.prdt_chk_code, 
         p.prdt_code, 
         p.prcs_rs_code,
          
         c.chk_name, 
         c.chk_std,
          
         d.prdt_chk_val
        
         
    FROM prdt_chk p 
    JOIN dt_prdt_chk d 
      ON p.prdt_chk_code = d.prdt_chk_code
    JOIN chk_std c 
      ON d.chk_std_code = c.chk_std_code
  
   WHERE p.prdt_chk_code = #{prdtChkCode}
  </select>
  
  <!-- 완제품 합격검사 -->
  <select id="selectPrdtFin" resultType="CheckVO">
  select *
  	from prdt_chk c
  	JOIN prdt_table t 
  	  ON c.prdt_code = t.prdt_code
  WHERE c.prdt_chk_result = '적합'
  		and c.prdt_fin_chk = '입고전'	  
  </select>
  
  <update id="updateFinChk" parameterType="CheckVO">
  update process
  set prod_yn = 'c'
  WHERE prcs_code = #{prcsCode}
  </update>
  </mapper>