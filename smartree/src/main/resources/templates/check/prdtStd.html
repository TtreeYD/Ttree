<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<title>SMARTREE</title>
<style>
#grid .tui-grid-body-area , #grid .tui-grid-layer-state{
	height : 40px !important;
}
#grid tbody td{
			cursor : pointer;
		}
</style>
</head>

<body>



	<div layout:fragment="content">
	<h2>품질검사기준관리</h2>
		<div class="btn-group btn-right" role="group"
			aria-label="Basic example"
			style="float: right; padding-bottom: 10px;">
			<button type="button" id="resetBtn" class="btn btn-primary">초기화</button>
			<button type="button" id="insertBtn" class="btn btn-primary">추가</button>
		</div>
		<div id="grid"style="margin-bottom: 150px;"></div>
		<div class="btn-group btn-right" role="group"
			aria-label="Basic example"
			style="float: right; padding-bottom: 10px;">
			<button type="button" id="prdtStdBtn" class="btn btn-primary">검사기준조회</button>
			<button type="button" id="delBtn" class="btn btn-primary">선택삭제</button>
			<button type="button" id="addBtn" class="btn btn-primary">저장</button>
		</div>
		<div id="grid2"></div>
		

<!-- 제품모달 -->
		<div class="modal fade" tabindex="-1" role="dialog" id="prModal">
			<div class="modal-dialog modal-dialog-centered modal-xl" role="document">
				<div class="modal-content">
					<h2 style="margin:30px">제품목록</h2>
					
					
					<div class="modal-body">
						<div id="prdtListModal"></div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->

<!-- 검사기준모달 -->
		<div class="modal fade" tabindex="-1" role="dialog" id="prStdModal">
			<div class="modal-dialog modal-dialog-centered modal-xl" role="document">
				<div class="modal-content">
					<h2 style="margin:30px">검사기준조회</h2>
					
					
					<div class="modal-body">
						<div id="prdtStdModalGrid"></div>
					</div>
					<div class="modal-footer">
					<button type="button" id="addModalBtn" class="btn btn-default">저장</button>
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div><!-- /.modal-content -->
			</div><!-- /.modal-dialog -->
		</div><!-- /.modal -->
		
		<script>
		var grid;
			window.onload = function() {
				//화면 제품그리드
				 grid = new tui.Grid({
					el : document.getElementById('grid'),
					scrollX : false,
					scrollY : false,
					contextMenu : null,
					rowHeaders : [ "rowNum" ],
					//bodyHeight : 20px,
					header : {
						background : 'yellow'
					},	
					columns : [ {
						header : '제품코드',
						name : 'prdtCode',
						align : 'center',
						editor : 'text',
						value : '',
					}, {
						header : '제품명',
						name : 'prdtName',
						editor : 'text',
						value : '',
						align : 'center'
					}, {
						header : '분류',
						name : 'prdtType',
						align : 'center'
					}, 
					]
				});
					//제품모달그리드
					const prdtListModal = new tui.Grid({
						el : document.getElementById('prdtListModal'),
						scrollX : false,
						scrollY : true,
						pageOptions : {
							perPage : 5,
							useClient : true,
						},
						columns : [ {
							header : '제품코드',
							name : 'prdtCode',
							align : 'center'
						}, {
							header : '제품명',
							name : 'prdtName',
							align : 'center'
						}, {
							header : '분류',
							name : 'prdtType',
							align : 'center'
						}, 

						],
					});
					
					const grid2 = new tui.Grid({
						el : document.getElementById('grid2'),
						scrollX : false,
						scrollY : false,
						contextMenu : null,
						rowHeaders : [ "checkbox" ],
						bodyHeight : 300,
						header : {
							background : 'yellow'
						},	
						columns : [ {
							header : '완제품코드',
							name : 'prdtCode',
							align : 'center',
							hidden : true
						},{	
							header : '검사기준코드',
							name : 'chkStdCode',
							align : 'center',
						}, {
							header : '검사명',
							name : 'chkName',			
							align : 'center'
						}, {
							header : '검사설명',
							name : 'chkDt',
							align : 'center'
						}, {
							header : '검사기준',
							name : 'chkStd',
							align : 'center'
						}, {
							header : '검사순서',
							name : 'prdtChkNum',
							align : 'center',
							editor : 'text'
						},
						]
					});
					
					//검사기준모달그리드
					const prdtStdModalGrid = new tui.Grid({
						el : document.getElementById('prdtStdModalGrid'),
						scrollX : false,
						scrollY : false,
						rowHeaders : [ "checkbox" ],
						pageOptions : {
							perPage : 5,
							useClient : true,
						},
						columns : [ {
							header : '검사기준코드',
							name : 'chkStdCode',
							align : 'center'
						}, {
							header : '검사명',
							name : 'chkName',
							align : 'center'
						}, {
							header : '검사설명',
							name : 'chkDt',
							align : 'center'
						}, {
							header : '검사기준',
							name : 'chkStd',
							align : 'center'
						}, 

						]
					});
					
					toastr.options = {
			  			  positionClass: "toast-top-center",
			  			  escapeHtml: true,
			  			  closeButton: true,
			 			  newestOnTop: false,
			  			  timeOut: 1250
			  			};
					
					
				$('#insertBtn').on('click', function() {
				let newGrid = grid.appendRow({
						'prdtCode' : ``,
						'prdtName' : ``,
						'prdtType' : ``,
					}, {
						at : 0
					});
				});
				
				//제품명 클릭이벤트
				grid.on('click',(ev)=>{
					if(ev.columnName != 'prdtCode' && ev.columnName !='prdtName'){
							return;	
					}
					$.ajax({
						url:'/selectprdt',
						method:'GET',
						success:function(result){
							prdtListModal.resetData(result);
							setTimeout(() => prdtListModal.refreshLayout(), 200);
							$('#prModal').modal('show');
							
						},
						error:function(err){
							console.log(err)
						}
					});
				});
				
				//제품 더블클릭 이벤트
				prdtListModal.on('dblclick',(ev)=>{
					if(ev.rowKey==undefined){
		        		return;
		        	}
					let data = prdtListModal.getValue(ev.rowKey,'prdtCode');
					$.ajax({
						url:'/prdtList',
						method:'GET',
						data:{
							prdtCode : data
						},
						success:function(result){
							console.log(data);
							grid.resetData(result);
							$('#prModal').modal('hide');
						},
						error:function(err){
							console.log(err)
						}
						
					})
				});
				
				
				//페이지 초기화버튼
				$('#resetBtn').on('click',function(){
					let data = grid.getData();

					for (let i = 0; i < data.length; i++) {
						data[i].prdtCode = ''; 
						data[i].prdtName = ''; 
					}
					grid.resetData([]);
					grid2.resetData([]);
				});
				
				//검사기준조회 이벤트
				 $('#prdtStdBtn').on('click', function () {					 
					 $.ajax({
							url:'/prdtStdList',
							method:'GET',
							success:function(result){
								console.log(result);
								prdtStdModalGrid.resetData(result);
								setTimeout(() => prdtStdModalGrid.refreshLayout(), 200);
								$('#prStdModal').modal('show');
							},
							error:function(err){
								console.log(err);
							}
		
						})
				 });
				
				// 모달창 저장버튼이벤트
				 $('#addModalBtn').on('click', function (ev) {
					 if(!ev.rowKey==undefined){
							// 체크여부확인 경고창
							alert("체크하세요");
			        		return; 
			        }
					 	let datas = prdtStdModalGrid.getCheckedRows();
					 	console.log(grid.getValue(0,"prdtCode"));
					 	let prdtCode = grid.getValue(0,"prdtCode");
					 	
					 	datas.forEach((data,index)=>{
					 		data.prdtCode= prdtCode;
					 		
					 	})
					 	
						grid2.appendRows(datas);
						$("#prStdModal").modal('hide');
		        });
				
				// 선택삭제 이벤트
				 $('#delBtn').on('click', function() {
					  let selectedRows = grid2.getCheckedRows(); 
					  if (selectedRows.length == 0) {
						  toastr.warning('선택된 행이 없습닌다');
					  } else {
					    selectedRows.forEach(function(row) {
					    	console.log(row);
					      grid2.removeRow(row.rowKey);
					      
					    });
					  }
					});
				
				// 저장 이벤트
				$('#addBtn').on('click',function(){
					let datas = grid2.getData();
					console.log(datas);
					$.ajax({
						url: '/insertPrdtChkList', 
						method: 'post',
						dataType: 'json',
						contentType : 'application/json',
						data : JSON.stringify(datas),
						success: function(result) {
							console.log(datas);
							toastr.success('저장완료');
							grid.resetData([]);
							grid2.resetData([]);
						},
						error: function(err) {
							console.log(err);
						}
					});
				});
				
				
			}
		</script>

	</div>
</body>
</html>