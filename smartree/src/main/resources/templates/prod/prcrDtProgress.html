<!DOCTYPE html>
<html xmlns:th="https://www.thymeleaf.org/">
<head>
<meta charset="UTF-8">
<title>공정실적관리:생산진행상세</title>

<link href="https://fonts.googleapis.com/css?family=Righteous" rel="stylesheet">
<link rel="preconnect" href="https://fonts.gstatic.com">
<link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
<link href="../startbootstrap/css/kiosk.css" rel="stylesheet" type="text/css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11.4.10/dist/sweetalert2.min.css">
<!-- 그리드관련 link -->
<link rel="stylesheet" type="text/css" href="https://uicdn.toast.com/grid/latest/tui-grid.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css" />
<link rel="stylesheet" href="https://uicdn.toast.com/tui.chart/latest/tui-chart.css"> 

<!-- 그리드관련 script -->
<script src="https://code.jquery.com/jquery-3.7.1.js"integrity="sha256-eKhayi8LEQwp4NKxN+CfCh+3qOVUtJn3QNZ0TciWLP4="crossorigin="anonymous"></script>
<script src="../startbootstrap/vendor/jquery/jquery.min.js"></script>
<script src="../startbootstrap/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
<script src="../startbootstrap/vendor/jquery-easing/jquery.easing.min.js"></script>
<script src="../startbootstrap/js/sb-admin-2.min.js"></script>


<script src="https://uicdn.toast.com/tui.pagination/latest/tui-pagination.js"></script>
<script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.js"></script>
<script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tui-grid@4.21.16/dist/tui-grid.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://kit.fontawesome.com/4791395687.js" crossorigin="anonymous"></script>
<style>
.modal-open {
  overflow: hidden;
}

.modal-open .modal {
  overflow-x: hidden;
  overflow-y: auto;
}

.modal {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1050;
  display: none;
  width: 100%;
  height: 100%;
  overflow: hidden;
  outline: 0;
}

.modal-dialog {
  position: relative;
  width: auto;
  margin: 0.5rem;
  pointer-events: none;
}

.modal.fade .modal-dialog {
  transition: transform 0.3s ease-out;
  transform: translate(0, -50px);
}

@media (prefers-reduced-motion: reduce) {
  .modal.fade .modal-dialog {
    transition: none;
  }
}

.modal.show .modal-dialog {
  transform: none;
}

.modal.modal-static .modal-dialog {
  transform: scale(1.02);
}

.modal-dialog-scrollable {
  display: flex;
  max-height: calc(100% - 1rem);
}

.modal-dialog-scrollable .modal-content {
  max-height: calc(100vh - 1rem);
  overflow: hidden;
}

.modal-dialog-scrollable .modal-header,
.modal-dialog-scrollable .modal-footer {
  flex-shrink: 0;
}

.modal-dialog-scrollable .modal-body {
  overflow-y: auto;
}

.modal-dialog-centered {
  display: flex;
  align-items: center;
  min-height: calc(100% - 1rem);
}

.modal-dialog-centered::before {
  display: block;
  height: calc(100vh - 1rem);
  height: -webkit-min-content;
  height: -moz-min-content;
  height: min-content;
  content: "";
}

.modal-dialog-centered.modal-dialog-scrollable {
  flex-direction: column;
  justify-content: center;
  height: 100%;
}

.modal-dialog-centered.modal-dialog-scrollable .modal-content {
  max-height: none;
}

.modal-dialog-centered.modal-dialog-scrollable::before {
  content: none;
}

.modal-content {
  position: relative;
  display: flex;
  flex-direction: column;
  width: 300px;
  pointer-events: auto;
  background-color: #fff;
  background-clip: padding-box;
  border: 1px solid rgba(0, 0, 0, 0.2);
  border-radius: 0.3rem;
  outline: 0;
}

.modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  z-index: 1040;
  width: 100vw;
  height: 100vh;
  background-color: #000;
}

.modal-backdrop.fade {
  opacity: 0;
}

.modal-backdrop.show {
  opacity: 0.5;
}

.modal-header {
  display: flex;
  align-items: flex-start;
  justify-content: space-between;
  padding: 1rem 1rem;
  border-bottom: 1px solid #e3e6f0;
  border-top-left-radius: calc(0.3rem - 1px);
  border-top-right-radius: calc(0.3rem - 1px);
}

.modal-header .close {
  padding: 1rem 1rem;
  margin: -1rem -1rem -1rem auto;
}

.modal-title {
  margin-bottom: 0;
  line-height: 1.5;
}

.modal-body {
  position: relative;
  flex: 1 1 auto;
  padding: 1rem;
}

.modal-footer {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  justify-content: flex-end;
  padding: 0.75rem;
  border-top: 1px solid #e3e6f0;
  border-bottom-right-radius: calc(0.3rem - 1px);
  border-bottom-left-radius: calc(0.3rem - 1px);
}

.modal-footer > * {
  margin: 0.25rem;
}

.modal-scrollbar-measure {
  position: absolute;
  top: -9999px;
  width: 50px;
  height: 50px;
  overflow: scroll;
}

@media (min-width: 576px) {
  .modal-dialog {
    max-width: 500px;
    margin: 1.75rem auto;
  }
  .modal-dialog-scrollable {
    max-height: calc(100% - 3.5rem);
  }
  .modal-dialog-scrollable .modal-content {
    max-height: calc(100vh - 3.5rem);
  }
  .modal-dialog-centered {
    min-height: calc(100% - 3.5rem);
  }
  .modal-dialog-centered::before {
    height: calc(100vh - 3.5rem);
    height: -webkit-min-content;
    height: -moz-min-content;
    height: min-content;
  }
  .modal-sm {
    max-width: 300px;
  }
}

@media (min-width: 992px) {
  .modal-lg,
  .modal-xl {
    max-width: 800px;
  }
}

@media (min-width: 1200px) {
  .modal-xl {
    max-width: 1140px;
  }
}

#numericInput{
    position:relative;
    width: 500px;
}
#numBox{
	height: 45px;
    text-align:right;
	padding: 2px 10px;
    cursor:text;
}

.Dotkey{
    border:solid 1px #887226;
    background-color:#F8F1DA;	
    text-align:center;
	font-weight:bold;
	font-size:10pt;
	border-radius:6px;
    font-weight:bold;
    color:black;
    cursor:pointer;
}
.delKey{
    border:solid 1px #887226;
    background-color:#F8F1DA;
    text-align:center;
	border-radius:6px;
    font-weight:bold;
    color:black;
    cursor:pointer;
}
.delKey:hover{
	background-color:#F0D060;
}
.delKey:active{
	background-color:black;
}
.key{
    border:solid 1px #887226;
    background-color:#F8F1DA;
    text-align:center;
	border-radius:6px;
    font-weight:bold;
    color:black;
    cursor:pointer;
}
.key:hover{
    background-color:#F0D060;
}
.key:active{
    background-color:black;
}
.btn{
    border:solid 1px #946046;
    text-align:center;
	border-radius:6px;
    color:black;
    cursor:pointer;
    background-color:#F0D5C8;
    width:33.3%;
	height:43px;
}
.btn:hover{
    background-color:#E7AB9F;
}
.btn:active{
    background-color:#E7AB9F;
}


* :not(h1){
text-align:center;
font-size: 30px;
}
input[type="range"] {
overflow: hidden;
height: 30px;
-webkit-appearance: none;
margin: 10px 0;
width: 100%;
background: transparent;


}

input[type="range"]:focus {
outline: none;
}

input[type="range"]::-webkit-slider-runnable-track {
width: 100%;
height: 100%;
cursor: pointer;
border-radius: 5px;
border: 2px solid #d64242;
}

input[type="range"]::-webkit-slider-thumb {
-webkit-appearance: none;
width: 0px;
height:0px;
background: #ff494f;
box-shadow: 1px 1px 7px #d16a6e;
cursor: pointer;
box-shadow: -100vw 0 0 100vw rgb(231, 17, 17);
}
.bigbutton {
  width: 600px;
  height: 300px;
  border-radius: 25px;
  display: inline-block;
  border: 1px solid black;
  vertical-align: top; /* 버튼을 상단에 정렬합니다 */
  /* 기존의 margin-top 스타일을 제거합니다 */
}



 button:active {
    box-shadow: 1px 1px 0 rgb(0,0,0,0.5);
    position: relative;
    top:2px;
  }
  .lightgrey .tui-grid-cell-current-row td{
  			box-shadow: 0px 0px 3px 5px rgba(0, 0, 0, 0.507) inset;
			
			font-weight: bold;
		}
#eqmGrid tbody td {
	cursor: pointer;
}

.prcr_dt_progres_content{
	position:relative;
}
.prcr_dt_progres_bottom_item{
	display: flex;
	justify-content: space-between;
	align-items: center;
	width: 100%;
}
.prcr_dt_progres_bottom_item{
	/*위아래 공백 조정*/
	margin-top: 50px;
}
#startBtn{
	/*버튼 좌우 위치 조정*/
	margin-right: 14%;
}
.tui-grid-cell.red {
	background-color: rgb(227, 52, 52);
	color: white;
	font-weight: bolder;
}

.tui-grid-cell.green {
	background-color: rgb(31, 193, 31);
	color: white;
	font-weight: bolder;
}
.tui-grid-cell.yellow {
	background-color: rgb(252, 255, 54);
	color: white;
	font-weight: bolder;
}
.swal-wide{
        width:800px !important;
    }
 .header{
            
            border: 1px solid black;
            width: 100%;
            height: 100px;
            background-color: #6fb7ff;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .header-content{
            display: flex;
            justify-content: space-between;
            width: 100%;
            margin: 0 30px;
        }
        .header-content-detail > i {
            font-size: 50px;

        }
        .header-content-detail > i:active{
            color: white;
        }

</style>
</head>
<body>
<div class="header">
        <div class="header-content">
            <h1>생산키오스크</h1>
            <div class="header-content-detail">
	            <i class="fa-solid fa-backward-step fa-sm"style="margin-right: 30px;" onclick="backBefore()"></i>
	            <i class="fa-solid fa-house" onclick="backHome()"></i>
            </div>
        </div>
 </div>
 <div class="prcr_dt_progres_content">
	<div id="instDtGrid"></div>
	<div class="prcr_dt_progres_bottom_item">
	<div id="eqmGrid" class="lightgrey" style="width: 600px;"></div>
	
	<button class="bigbutton" id="startBtn" style="background-color: rgb(94, 155, 248);">작업시작</button>
	
	</div>
 </div>
 
 <div class="modal fade" tabindex="-1" role="dialog" id="myModal" style="margin-left: 350px;">
      <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
        <div class="modal-content" style="height:500px;width:500px;">
            <div id="numericInput" >
			    <div id="numBox"></div>
			    <table id="keypad" bgcolor = #FF856D style="width:500px; height:500px; border: 1px solid black;">
			        <tr>
			            <td class="key">1</td>
			            <td class="key" style="width:160px;">2</td>
			            <td class="key">3</td>
			        </tr>
			        <tr>
			            <td class="key">4</td>
			            <td class="key">5</td>
			            <td class="key">6</td>
			        </tr>
			        <tr>
			            <td class="key">7</td>
			            <td class="key">8</td>
			            <td class="key">9</td>
			        </tr>
			        <tr>
			            <td class="delKey" id="deleteBtn"style="background-color:#F0D5C8;">←</td>
			            <td class="key" style="height:120px;">0</td>
			            <td class="btn" id = "enter_key">저장</td>
			        </tr>
			    </table>
			</div>
          </div>
      </div><!-- /.modal-dialog -->
    </div><!-- /.modal -->
<script th:inline="javascript">









var data = [[${data}]]
let manager = [[${session.loginMember.empName}]];
console.log(data)
let clickdata ;
let eqmdata;

const instDtGrid = new tui.Grid({
	el : document.getElementById('instDtGrid'),
	scrollX : false,
	scrollY : false,
	header:{
		height:100,
	},
	rowHeight:200,
	columns : [
		{
	          header: '공정흐름도코드',
	          name: 'prcsCode',
	          
	        },
	        {
	          header: '제품코드',
	          name: 'prdtCode'
	        },
	        {
	          header: '제품명',
	          name: 'prdtName'
	        },
	        {
	          header: '공정순서',
	          name: 'prcsOrder'
			},
	        {
	          header: '담당자',
	          name: 'manager',
	          editor: 'text'
		    },
	        
	        {
	          header: '지시량',
	          name: 'prdtTotal'
	        },
	        {
	          header: '생산예정량',
	          name: 'prdtCnt',
	          editor: {
	        	  type: 'text'
	          }
		     },
	        {
	          header: '현생산량',
	          name: 'prdtProdSum'
		     },
		     {
	          header: '불량량',
	          name: 'prdtProdErrCnt'
		     }

	]})
	
const eqmGrid = new tui.Grid({
	el : document.getElementById('eqmGrid'),
	scrollX : false,
	scrollY : false,
	rowHeight:50,
	 header: {
	        height: 100,
	        complexColumns: [
	          {
	            header: '설비선택',
	            name: 'mergeColumn1',
	            childNames: ['eqmName', 'eqmState']
	          }
	        ]
	      },
	      columns: [
	        {
	          header: '설비코드',
	          name: 'eqmCode',
	          hidden: true
	        }, 
	        {
	          header: '설비명',
	          name: 'eqmName'
	        },
	        {
	          header: '가동상태',
	          name: 'eqmState'
	        }
	      ]
	    });
	    
$(document).ready(function (){
	getProcess();
	$('#myModal').modal('hide');
	//단건조회 
	function getProcess(){
		$.ajax({
			url:'/getProcess',
			method:'GET',
			data: {
				prcsCode: data
			},	
			success:function(result){
				let vo = {};
				
				vo.prcsOrder = result[0].prcsOrder;
				vo.prdtCode = result[0].prdtCode;
				console.log(vo)
				$.ajax({
					url: '/selectPrcsCode',
					method: 'post',
					contentType : 'application/json',
					data: JSON.stringify(vo),
					success: result2 => {
						result[0].prcsStdCode = result2[0].prcsStdCode
						
						result[0].manager = manager;
						instDtGrid.resetData(result);
						
						  for(let i = 0 ; i<result2.length ; i++){
							if(result2[i].eqmState == 'N'){
								result2[i].eqmState = '사용중';
								result2[i]._attributes= {
		    	            			className:{
		    	            				column : {
		    	            					eqmName : ['yellow'],
		    	            					eqmState:['yellow']
		    	            				}
		    	            			}
		    		            	}
							}else if(result2[i].eqmState == 'Y'){
								result2[i].eqmState = '사용가능';
								result2[i]._attributes= {
		    	            			className:{
		    	            				column : {
		    	            					eqmName : ['green'],
		    	            					eqmState:['green']
		    	            				}
		    	            			}
		    		            	}
							}else{
								result2[i].eqmState = '사용불가';
								result2[i]._attributes= {
		    	            			className:{
		    	            				column : {
		    	            					eqmName : ['red'],
		    	            					eqmState:['red']
		    	            				}
		    	            			}
		    		            	}
							}
						}  
						eqmGrid.resetData(result2);
					}
				})
					
			},
			error:function(err){
				console.log(err);
			}
		})
	}
	eqmGrid.on('click',function(ev){
		clickdata = eqmGrid.getValue(ev.rowKey , 'eqmCode');
		eqmdata = eqmGrid.getValue(ev.rowKey, 'eqmState');
	})
	//공정시작
	$('#startBtn').on('click',function(){
		cntdata = instDtGrid.getData();
		console.log(cntdata)
		if(cntdata[0].prdtCnt==0){
			Swal.fire({
				icon: 'error',
				title: '생산량을 확인하세요',
				customClass: 'swal-wide'
			})
			return
		}
		if(eqmdata =='사용중' || eqmdata == '사용불가' || eqmdata == null){
			Swal.fire({
				  icon: 'error',
				  title: '설비를 확인하세요',
				  customClass: 'swal-wide'
				})
			return;
		}else if( Number(cntdata[0].prdtProdSum) + Number(cntdata[0].prdtCnt)>cntdata[0].prdtTotal  ){
			Swal.fire({
				  icon: 'error',
				  title: '지시량을 초과했습니다',
				  customClass: 'swal-wide'
				})
				return;
		}else{
			let req={};
			req.list = instDtGrid.getData(); 
			req.list[0].eqmCode = clickdata;
			
			req.vo = {
					eqmCode: clickdata,
					prcsCode: data
			}
		
			console.log(req)
			$.ajax({
				url:'/insertDtProgress',
				method:'POST',
				dataType: 'json',
				contentType : 'application/json',
				data:JSON.stringify(req),
				success:function(result){
					Swal.fire({
						  position: 'center',
						  icon: 'success',
						  title: '작업이 시작되었습니다',
						  showConfirmButton: false,
						  timer: 1500
						})
						getProcess();
					console.log(result)
				},
				error:function(err){
					console.log(err);	
				}
			})
		}
		
	})
	instDtGrid.on('click',function(ev){
		if(ev.columnName == 'prdtCnt' && ev.targetType == 'cell'){
			$("#numBox").text('');
			console.log(ev)
			$('#myModal').modal('show');
		}
	})
	
	$('.key').click(function(){
    var numBox = document.getElementById('numBox');
    if(this.innerHTML == '0'){
        if (numBox.innerHTML.length > 0){
        	
            numBox.innerHTML = numBox.innerHTML + this.innerHTML;
        }
    }
    else{
    	
        numBox.innerHTML = numBox.innerHTML + this.innerHTML;
    	event.stopPropagation();
	    }
	});

		$('#deleteBtn').on('click',function(ev){
			let currentValue = $("#numBox").text();
			$('#numBox').text(currentValue.slice(0, -1))
		})
		$('#enter_key').on('click',function(ev){
			let currentValue = $("#numBox").text();
			instDtGrid.setValue(0, 'prdtCnt' , currentValue)
			$('#myModal').modal('hide');
		})
	
	
	
})
	function backHome(){
		$(location).attr('href', '/prod/prcrKiosk');
	}
	function backBefore(){
		$(location).attr('href', '/prod/prodProgress');
	}
</script>
</body>
</html>