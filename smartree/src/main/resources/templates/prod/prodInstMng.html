<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	layout:decorate="~{layout/layout}">
<head>
<meta charset="UTF-8">
<title>생산지시관리</title>
</head>
<style>
</style>
<body>
	<div layout:fragment="content">
	<h2>생산지시관리</h2>
		<label>지시명 : </label> <input type="text" name="prodInstName"
			id="prodInstName"><br> <label>담당자 : </label> <input
			type="text" name="prodInstManager" id="prodInstManager"><br> <label>생산지시일자
			: </label> <input type="date" name="prodInstDate" id="prodInstDate">
		<label>생산예상시작일자 : </label> <input type="date" name="prodInstSdate"
			id="prodInstSdate"> <label>생산예상종료일자 : </label> <input
			type="date" name="prodInstEdate" id="prodInstEdate">
			<input type="hidden" name="prodInstCode" id="prodInstCode">
		<div class="btn-group" role="group" aria-label="Basic example"
			style="float: right; margin-bottom: 10px;">
			<button type="button" class="btn btn-primary" id="resetBtn">초기화</button>
			<button type="button" class="btn btn-primary" id="prodListBtn">생산계획</button>
			<button type="button" class="btn btn-primary" id="prodInstListBtn">생산지시</button>
			<button type="button" class="btn btn-primary" id="saveBtn">저장</button>
			<button type="button" class="btn btn-primary" id="delBtn">삭제</button>
		</div>
		<div style="display: flex; flex-wrap: nowrap; justify-content: space-between; margin-top: 30px;">
			<div id="grid" style="width: 1100px;"></div>
			<div id="grid3" style="width: 500px;"></div>
		</div>
		
		<div class="modal fade" tabindex="-1" role="dialog" id="prodInstModal">
			<div class="modal-dialog modal-dialog-centered modal-xl"
				role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title">생산지시 조회</h4>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div id="grid4"></div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
		<!-- /.modal -->
		
		<div class="modal fade" tabindex="-1" role="dialog" id="prodModal">
			<div class="modal-dialog modal-dialog-centered modal-xl"
				role="document">
				<div class="modal-content">
					<div class="modal-header">
						<h4 class="modal-title">생산계획 조회</h4>
						<button type="button" class="close" data-dismiss="modal"
							aria-label="Close">
							<span aria-hidden="true">&times;</span>
						</button>
					</div>
					<div class="modal-body">
						<div id="grid5"></div>
					</div>
					<div class="modal-footer">
						<button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
					</div>
				</div>
				<!-- /.modal-content -->
			</div>
			<!-- /.modal-dialog -->
		</div>
		<!-- /.modal -->

		<script>
		let newGrid = [];	// newGrid에 grid 값들을 넣어주고 거기에 새계획 눌렀을 때도 추가하기 위해 만든 변수
		let rowNum;			// 해당 rowNum 값을 담기위해 만든 변수
		let getProdPlanCode;
		let grid, grid2, grid3, grid4, grid5, grid6;
        const header = ['prodInstName','prodInstManager','prodInstDate','prodInstSdate', 'prodInstEdate', 'prodInstCode'];
        
        window.onload=function(){
	    const grid = new tui.Grid({
	    	// 생산계획 등록및 수정 그리드
	      	el: document.getElementById('grid'),
	      	scrollX: false,
	      	scrollY: false,
	      	bodyHeight : 400,
          	rowHeaders : ["checkbox"],
	      	columns: [
	      		{
		          header: '생산지시상세코드',
		          name: 'dtProdInstCode',
		          hidden : true
		        },
		        {
		          header: '생산코드',
		          name: 'prodPlanCode',
		          hidden : true
		        },
		        {
		          header: '제품명',
		          name: 'prdtName'
		        },
		        {
		          header: '계획명',
		          name: 'prodPlanName'
		        },
		        {
		          header: '계획량',
		          name: 'prodPlanCnt'
		        },
		        {
		          header: '지시우선순위',
		          name: 'prodInstRank',
		          editor : 'text'
		        },
		        {
		          header: '지시량',
		          name: 'prodInstCnt',
	        	  editor : 'text'
		        },
		        {
		          header: '계획-지시수량차',
		          name: 'prodinstIncompCnt'
		        },
		        
		        {
		          header: '생산지시완료여부',
		          name: 'prodInstYn',
		          hidden : true
		        },
	      	]
	    	});
	    
	    const grid3 = new tui.Grid({
	    	// 하단 자재 그리드
			el: document.getElementById('grid3'),
	      	scrollX: false,
	      	scrollY: false,
	      	bodyHeight : 400,
	      	pageOptions: {
            	perPage: 5,
            	useClient: true,
          	},
	      	columns: [
	        	{
		          header: '자재코드',
		          name: 'mtlCode',
		          hidden: true
		        },
		        {
		          header: '자재명',
		          name: 'mtlName'
		        },
		        {
		          header: '요구량',
		          name: 'mtlNeed'
		        },
		        {
		          header: '홀드수량',
		          name: 'holdingCnt'
		        }
	      	]
	    });
	    const grid4 = new tui.Grid({
	    	// 생산계획 모달 그리드
	      	el: document.getElementById('grid4'),
	      	scrollX: false,
	      	scrollY: false,
	      	pageOptions: {
	            perPage: 5,
	            useClient: true,
          	},
	      	columns: [
    	  		{
	              header: '지시코드',
	              name: 'prodInstCode',
	              hidden : true
	            },
	            {
	              header: '지시명', 
	              name: 'prodInstName'
	            },
	            {
	              header: '지시담당자', 
	              name: 'prodInstManager'
	            },
	            {
	              header: '지시일자', 
	              name: 'prodInstDate'
	            },
	            {
	              header: '지시예상시작일자', 
	              name: 'prodInstSdate'
	            },
	            {
	              header: '지시예상종료일자', 
	              name: 'prodInstEdate'
	            }
   	       ]
 	   });
	    const grid5 = new tui.Grid({
	    	// 생산계획 모달 그리드
	      	el: document.getElementById('grid5'),
	      	scrollX: false,
	      	scrollY: false,
	      	pageOptions: {
	            perPage: 5,
	            useClient: true,
          	},
	      	columns: [
    	  		{
	              header: '계획코드',
	              name: 'prodPlanCode'
	            },
		    	{
	              header: '계획명',
	              name: 'prodPlanName'
	            },
	            {
	              header: '담당자',
	              name: 'prodName'
	            },
	            {
	              header: '생산계획일자',
	              name: 'prodPlanDate',
	            }
   	       ]
 	   });
		
		// 생산계획 버튼 모달
		$('#prodListBtn').on('click', prodIngList);
		
		function prodIngList(){
			$.ajax({
				url:'/selectProdPlan',
				method:'get',
		    	dataType:'json',
				success:function(result){
					grid5.resetData(result);
					$("#prodModal").modal('show');
					setTimeout(() => grid5.refreshLayout(), 200);
				},
				error:function(err){
					console.log(err);
				}
			})
		}
		// 생산지시 버튼 모달
		$('#prodInstListBtn').on('click', prodInstIngList);
		
		function prodInstIngList(){
			$.ajax({
				url:'/selectProdInst',
				method:'get',
		    	dataType:'json',
				success:function(result){
					grid4.resetData(result);
					$("#prodInstModal").modal('show');
					setTimeout(() => grid4.refreshLayout(), 200);
				},
				error:function(err){
					console.log(err);
				}
			})
		}
		//페이지 초기화버튼
		$('#resetBtn').on('click', resetList)
		
		function resetList(){
			var data = grid.getData();

			grid.resetData([]);
			grid2.resetData([]);
			grid3.resetData([]);
			newGrid = [];
			$('#prodInstCode').val('');
			$('#prodInstName').val('');
			$('#prodInstManager').val('');
			$('#prodInstDate').val('');
			$('#prodInstSdate').val('');
			$('#prodInstEdate').val('');
		}
		
			// 저장 버튼
			$('#saveBtn').on('click',function(){
				grid.blur();
				var data = {};
				data.list = grid.getData();
				data.vo = {
					prodInstCode : $('#prodInstCode').val(),
					prodInstName : $('#prodInstName').val(),
					prodInstManager : $('#prodInstManager').val(),
					prodInstDate : $('#prodInstDate').val(),
					prodInstSdate : $('#prodInstSdate').val(),
					prodInstEdate : $('#prodInstEdate').val(),
					prodPlanCode : data.list[0].prodPlanCode
				}
				console.log(data);
			if(data.vo.prodInstCode != ''){
				$.ajax({
		      		url:'/updateProdInst',
		      		method: 'post',
					dataType: 'json',
					contentType : 'application/json',
					data : JSON.stringify(data),
		      		success:function(result){
		      			alert("수정완료");
		      			resetList();
		      		},
		      		error:function(err){
		      			console.log(err)
		      		}
	    		})
			}
		
			else {
				data.list = grid.getData();
				console.log(data);
				$.ajax({
		      		url:'/insertProdInst',
		      		method: 'post',
					dataType: 'json',
					contentType : 'application/json',
					data : JSON.stringify(data),
					
		      		success:function(result){
		      			alert("저장완료");
		      			resetList();
		      		},
		      		error:function(err){
		      			console.log(err)
		      		}
	    		})
			}
		})
		// 삭제버튼
		$('#delBtn').on('click', delBtnFunc);
			
		function delBtnFunc(){
			var data = {};
			data.list = grid.getCheckedRows();
			data.vo = {
				prodInstCode : $('#prodInstCode').val(),
				prodInstName : $('#prodInstName').val(),
				prodInstManager : $('#prodInstManager').val(),
				prodInstDate : $('#prodInstDate').val(),
				prodInstSdate : $('#prodInstSdate').val(),
				prodInstEdate : $('#prodInstEdate').val()
			}
			
			if(data.list.length == grid.getData().length){
				$.ajax({
					url:'/deleteProdInst',
					method: 'post',
					dataType: 'json',
					contentType : 'application/json',
					data : JSON.stringify(data),
					success:function(result){
						alert("전체삭제완료");
						resetList();
					},
					error:function(err){
						console.log(err)
					}
				})
			} else {
				data.vo.prodInstCode = null;
				$.ajax({
					url:'/deleteProdInst',
					method: 'post',
					dataType: 'json',
					contentType : 'application/json',
					data : JSON.stringify(data),
					success:function(result){
						alert(result + " 건 삭제완료");
						resetList();
					},
					error:function(err){
						console.log(err)
					}
				})
			}
		}
		// 생산지시 모달창 더블클릭
		grid4.on('dblclick',(ev)=>{
			if(ev.rowKey == undefined){
				return;
			}
			console.log(grid4.getData())
			let prodPlanCode = grid4.getValue(ev.rowKey, 'prodPlanCode');
			console.log(prodPlanCode);
			$.ajax({
				url : '/selectGetProdInst',
				method : 'get',
				data : { prodPlanCode : prodPlanCode },
				success : function(result){
					console.log(result);
					$('#prodInstCode').val(result[0].prodInstCode),
					$('#prodInstName').val(result[0].prodInstName),
					$('#prodInstManager').val(result[0].prodInstManager),
					$('#prodInstDate').val(result[0].prodInstDate),
					$('#prodInstSdate').val(result[0].prodInstSdate),
					$('#prodInstEdate').val(result[0].prodInstEdate)
					grid.resetData(result);
				 	$("#prodInstModal").modal('hide');	
				},
				error : function(err){
					console.log(err);
				}
			})
		})
		
		let mtlNeed = [];
		// 생산계획 모달창 더블클릭
		grid5.on('dblclick',(ev)=>{
			if(ev.rowKey == undefined){
				return;
			}
			let prodPlanCode = grid5.getValue(ev.rowKey, 'prodPlanCode');
			 
			$.ajax({
				url : '/selectGetProdPlan',
				method : 'get',
				data : { prodPlanCode : prodPlanCode },
				success : function(result){
					console.log(result);
					getProdPlanCode = result.list[0].prodPlanCode;
					console.log(getProdPlanCode)
					mtlNeed = result.mtlNeed
					grid3.resetData(mtlNeed)
					grid.resetData(result.list);
				 	$("#prodModal").modal('hide');	
				},
				error : function(err){
					console.log(err);
				}
			})
		})
		
		grid.on('afterChange', (ev) => {
			console.log(grid.getData())
			let mtlNeedList = [];
			for(let data of grid.getData()){
				for(let need of mtlNeed){
					
				}
				data.prdtCode
				data.prodInstCnt
			}
		})
		
		// 오늘날짜 input에 넣기
		today = new Date();
		console.log("today.toISOString() >>>" + today.toISOString());
		today = today.toISOString().slice(0, 10);
		console.log("today >>>> " + today);
		bir = document.getElementById("prodInstDate");
		bir.value = today;

	};
	  
    </script>
	</div>
</body>
</html>