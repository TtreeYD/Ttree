<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">

<head>
<meta charset="UTF-8">
<title>Insert title here</title>
</head>

<body>
	<div layout:fragment="content">
		<div class="container-xxl text-center">
			<div class="row">
				<div class="col-4">
					<div class="btn-group" role="group" aria-label="Basic example"
						style="float: left;">
						<button type="button" id="addCommonCode" class="btn btn-primary">추가</button>
						<button type="button" id="insertCommonCode"
							class="btn btn-primary">등록</button>
						<button type="button" id="deleteCommonCode"
							class="btn btn-primary">삭제</button>
					</div>
					<br> <br>
					<div id="commonCodeGrid"></div>
				</div>
				<div class="col-8">
					<div class="btn-group" role="group" aria-label="Basic example"
						style="float: right;">
						<button type="button" id="addCodeDetail" class="btn btn-primary">추가</button>
						<button type="button" id="insertCodeDetail"
							class="btn btn-primary">등록</button>
						<button type="button" id="deleteCodeDetail"
							class="btn btn-primary">삭제</button>
					</div>
					<br> <br>
					<div id="codeDetailGrid"></div>
				</div>
			</div>
		</div>


		<script>
			var Grid = tui.Grid;
			let commonCode = [];
			let codeDetail = [];
			let codeType;
			let cdl;

			let options = {
				cell: {
					disabled: {
						text: '#000000'
					}
				}
			}
			tui.Grid.applyTheme('default', options);
	
		    class CustomTextEditor {
		        constructor(props) {
		          const el = document.createElement('input');
		          el.value = String(props.value);
			       el.type = 'text';
			       if(props.rowKey<cdl) el.readOnly=true;
		          this.el = el;
		        }

		        getElement() {
		          return this.el;
		        }

		        getValue() {
		          return this.el.value;
		        }

		        mounted() {
		          this.el.select();
		        }
		      }
			
			const grid = new Grid({
				el: document.getElementById('commonCodeGrid'),
				scrollX: false,
				bodyHeight: 600,
				contextMenu: null,
				rowHeaders: ['rowNum', 'checkbox'],
				columns: [{
					header: '공통코드',
					name: 'codeType'
				}, {
					header: '코드명',
					name: 'typeName',
					editor: {
						type: 'text'
					}
				}]
			});


			const grid2 = new Grid({
				el: document.getElementById('codeDetailGrid'),
				scrollX: false,
				bodyHeight: 600,
				contextMenu: null,
				rowHeaders: ['rowNum', 'checkbox'],
				columns: [{
					header: '상세코드',
					name: 'codeId',
					editor: CustomTextEditor
					
				}, {
					header: '상세코드명',
					name: 'codeName',
					editor: {
						type: 'text'
					}
				}, {
					header: '사용여부',
					name: 'codeUse',
					editor: {
						type: 'select',
						options: {
							listItems: [{
									text: 'Y',
									value: 'Y'
								},
								{
									text: 'N',
									value: 'N'
								}
							]
						}
					}
				}]
			});

			selCommonCode();

			// 공통코드표시
			function selCommonCode() {
				$.ajax({
					url: "/selectCommonCode",
					success: result => {
						commonCode = result
						grid.resetData(commonCode);
					},
					error: err => console.log(err)
				})
			}
			
			grid.on('click', function (ev) {
				if (ev.rowKey == undefined) {
					return;
				}
				codeType = grid.getValue(ev.rowKey, 'codeType')
				selCodeDetail(codeType)
			})
			
			// 상세코드표시
			function selCodeDetail(ct){
				$.ajax({
					url: "/selectCodeDetail",
					data: {
						codeType: codeType
					},
					success: result => {
						codeDetail = result
						for(let data of codeDetail){
							data.codeType = codeType;
						}
						cdl = codeDetail.length;
						grid2.resetData(eval(codeDetail))
					},
					error: err => console.log(err)
				})
			}

			// 변경사항 저장
			grid.on('afterChange', ev => {
				let change = ev.changes
				commonCode[change[0].rowKey][change[0].columnName] = change[0].value
			})

			grid2.on('afterChange', ev => {
				let change = ev.changes
				codeDetail[change[0].rowKey][change[0].columnName] = change[0].value
			})

			// 공통코드등록
			$('#insertCommonCode').on('click', insertCommonCode)

			function insertCommonCode() {
				$.ajax({
					url: '/insertCommonCode',
					type: 'post',
					headers: {
						'Content-Type': 'application/json'
					},
					data: JSON.stringify(commonCode),
					success: result => {
						selCommonCode();
					},
					error: err => console.log(err)
				})
			}
			
			
			// 상세코드등록
			$('#insertCodeDetail').on('click', insertCodeDetail)
			
			function insertCodeDetail() {
				$.ajax({
					url: '/insertCodeDetail',
					type: 'post',
					headers: {
						'Content-Type': 'application/json'
					},
					data: JSON.stringify(codeDetail),
					success: result => {
						selCodeDetail(codeType)
					},
					error: err => console.log(err)
				})
			}
			
			// 공통코드추가
			$(addCommonCode).on('click', function () {
				commonCode.push({
					codeType: '',
					typeName: ''
				})
				grid.resetData(commonCode)
			})

			// 상세코드추가
			$(addCodeDetail).on('click', function () {
				if (!codeType) {
					alert('공통코드를 선택해주세요');
					return;
				}
				codeDetail.push({
					codeId: '',
					codeType: codeType,
					codeName: '',
					codeUse: 'Y'
				})
				grid2.resetData(codeDetail)
			})
			
			// 공통코드삭제
			$('#deleteCommonCode').on('click', deleteCommonCode)

			function deleteCommonCode() {
				let delData = grid.getCheckedRows()
				$.ajax({
					url: '/deleteCommonCode',
					type: 'post',
					headers: {
						'Content-Type': 'application/json'
					},
					data: JSON.stringify(delData),
					success: result => {
						//alert(result+ '건 삭제완료');	
						selCommonCode();
					},
					error: err => console.log(err)
				})
			}
			
			// 상세코드삭제
			$('#deleteCodeDetail').on('click', deleteCodeDetail)
			
			function deleteCodeDetail() {
				let delData = grid2.getCheckedRows()
				$.ajax({
					url: '/deleteCodeDetail',
					type: 'post',
					headers: {
						'Content-Type': 'application/json'
					},
					data: JSON.stringify(delData),
					success: result => {
						alert(result+ '건 삭제완료');	
						selCodeDetail(codeType)
					},
					error: err => console.log(err)
				})
			}		</script>
	</div>
</body>

</html>