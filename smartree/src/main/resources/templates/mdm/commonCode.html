<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout/layout}">

<head>
	<meta charset="UTF-8">
	<title>Insert title here</title>
</head>

<body>
	<div layout:fragment="content">
		<div class="container-xxl text-center">
			<div class="row">
				<div class="col-4">
					<div class="btn-group" role="group" aria-label="Basic example" style="float:left;">
						<button type="button" id="addCommonCode" class="btn btn-primary">추가</button>
						<button type="button" id="insertCommonCode" class="btn btn-primary">등록</button>
					</div>
					<br>
					<br>
					<div id="commonCodeGrid"></div>
				</div>
				<div class="col-8">
					<div class="btn-group" role="group" aria-label="Basic example" style="float:right;">
						<button type="button" id="addCodeDetail" class="btn btn-primary">추가</button>
						<button type="button" id="insertCodeDetail" class="btn btn-primary">등록</button>
					</div>
					<br>
					<br>
					<div id="codeDetailGrid"></div>
				</div>
			</div>
		</div>


		<script>
			var Grid = tui.Grid;
			let commonCode = [];
			let codeDetail = [];
			let codeType;

			let options = {
				cell: {
					disabled: {
						text: '#000000'
					}
				}
			}
			tui.Grid.applyTheme('default', options);

			const grid = new Grid({
				el: document.getElementById('commonCodeGrid'),
				scrollX: false,
				bodyHeight: 600,
				contextMenu: null,
				rowHeaders: ['rowNum', 'checkbox'],
				columns: [{
					header: '공통코드',
					name: 'codeType'
				}, {
					header: '코드명',
					name: 'typeName',
					editor: {
						type: 'text'
					}
				}]
			});


			const grid2 = new Grid({
				el: document.getElementById('codeDetailGrid'),
				scrollX: false,
				bodyHeight: 600,
				contextMenu: null,
				rowHeaders: ['rowNum', 'checkbox'],
				columns: [{
					header: '상세코드',
					name: 'codeId'
				}, {
					header: '상세코드명',
					name: 'codeName',
					editor: {
						type: 'text'
					}
				}, {
					header: '사용여부',
					name: 'codeUse',
					editor: {
						type: 'select',
						options: {
							listItems: [{
									text: 'Y',
									value: 'Y'
								},
								{
									text: 'N',
									value: 'N'
								}
							]
						}
					}
				}]
			});

			grid.on('click', function (ev) {
				if (ev.rowKey == undefined) {
					return;
				}
				codeType = grid.getValue(ev.rowKey, 'codeType')
				$.ajax({
					url: "/selectCommonCode",
					data: {
						codeType: codeType
					},
					success: result => {
						console.log(result)
						codeDetail = result
						grid2.resetData(eval(result))
					},
					error: err => console.log(err)
				})
			})

			grid.on('afterChange', ev => {
				let change = ev.changes
				commonCode[change[0].rowKey][change[0].columnName] = change[0].value
			})

			grid2.on('afterChange', ev => {
				let change = ev.changes
				codeDetail[change[0].rowKey][change[0].columnName] = change[0].value
			})

			selCodeType();

			function selCodeType() {
				$.ajax({
					url: "/selectCommonCodeType",
					success: result => {
						commonCode = result
						console.log(commonCode)
						grid.resetData(commonCode);
					},
					error: err => console.log(err)
				})
			}

			$('#insertCommonCode').on('click', insertCommonCode)

			let commonCodeList = [];

			function insertCommonCode() {
				for (let data of commonCode) {
					if (!data.codeType && data.typeName) {
						console.log(data.typeName)
						commonCodeList.push(data.typeName)
					}
				}
				console.log(commonCodeList)
				$.ajax({
					url: '/insertCommonCode',
					type: 'post',
					headers: {
						'Content-Type': 'application/json'
					},
					data: JSON.stringify(commonCodeList),
					success: result => {
						console.log(result)
						selCodeType();
					},
					error: err => console.log(err)
				})
				commonCodeList = [];
			}


			$(addCommonCode).on('click', function () {
				commonCode.push({
					codeType: '',
					typeName: ''
				})
				grid.resetData(commonCode)
			})

			$(addCodeDetail).on('click', function () {
				if (!codeType) {
					alert('공통코드를 선택해주세요');
					return;
				}
				codeDetail.push({
					codeId: '',
					codeName: '',
					codeUse: 'Y'
				})
				grid2.resetData(codeDetail)
			})
		</script>
	</div>
</body>

</html>